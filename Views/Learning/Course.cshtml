@* @model ELearningPlatform.Models.Course

@{
    ViewData["Title"] = Model.Title;
    var completedLessonIds = ViewData["CompletedLessonIds"] as List<int> ?? new List<int>();
}

<h1>@Model.Title</h1>
<hr />

<div class="row">
    <div class="col-md-4">
        <h4>Course Content</h4>
        @foreach (var module in Model.Modules.OrderBy(m => m.Id))
        {
            <h5>@module.Title</h5>
            <ul class="list-group mb-3">
                @foreach (var lesson in module.Lessons.OrderBy(l => l.Id))
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center lesson-item" id="lesson-@lesson.Id">
                        <div class="lesson-title">
                            @if (completedLessonIds.Contains(lesson.Id))
                            {
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                            }
                            @lesson.Title
                        </div>
                        @if (!completedLessonIds.Contains(lesson.Id))
                        {
                            <form class="mark-complete-form" data-lesson-id="@lesson.Id" data-course-id="@Model.Id" method="post">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-success">Complete</button>
                            </form>
                        }
                        else
                        {
                            <span class="badge bg-success">Done</span>
                        }
                    </li>
                }
            </ul>
        }
    </div>
    <div class="col-md-8">
        <h4>Lesson Details</h4>
        <div class="card">
            <div class="card-body">
                <p>Lesson content will be displayed here. Select a lesson from the list.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
        $(document).on("submit", ".mark-complete-form", function (e) {
            e.preventDefault();

            var form = $(this);
            var lessonId = form.data("lesson-id");
            var courseId = form.data("course-id");

            $.ajax({
                url: '@Url.Action("MarkAsComplete", "Learning")',
                type: 'POST',
                data: {
                    lessonId: lessonId,
                    courseId: courseId,
                    __RequestVerificationToken: form.find('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        var lessonItem = $("#lesson-" + lessonId);

                        // Add check icon
                        lessonItem.find(".lesson-title").prepend('<i class="bi bi-check-circle-fill text-success me-2"></i>');

                        // Replace form with "Done" badge
                        form.replaceWith('<span class="badge bg-success">Done</span>');
                    } else {
                        alert(response.message || "Error marking lesson as complete.");
                    }
                },
                error: function () {
                    alert("Something went wrong. Please try again.");
                }
            });
        });
    </script>
} *@


@model ELearningPlatform.Models.Course

@{
    ViewData["Title"] = Model.Title;
    var isCourseCompleted = ViewData["IsCourseCompleted"] as bool? ?? false;
}

<h1>@Model.Title</h1>
<hr />

@if (isCourseCompleted)
{
    <div class="alert alert-success">
        Congratulations! You completed this course.
    </div>
}
else
{
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Finish the Course</h5>
            <p class="card-text">Once you have completed all lessons, you can mark the entire course as complete.</p>
            <form asp-controller="Learning" asp-action="MarkCourseAsComplete" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="courseId" value="@Model.Id" />
                <button type="submit" class="btn btn-primary">Mark Course as Complete</button>
            </form>
        </div>
    </div>
}